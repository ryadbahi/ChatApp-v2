import{j as e}from"./ui-vendor-BEMU751j.js";import{d as A,u as _,r as d}from"./react-vendor-oin3n_bH.js";import{e as k,s as o,v as R}from"./auth-CEE9aHD-.js";import{b as D,m as b}from"./social-PyUT3FD-.js";import{M as I,d as U}from"./chat-xRr-uYkC.js";import{c as E}from"./index-DYiw4HW8.js";import"./socket-vendor-BLRFddlS.js";import"./editor-vendor-DpIsqUJN.js";const P=()=>{const{userId:t}=A(),g=_(),{user:f}=k(),[u,n]=d.useState([]),[c,v]=d.useState(null),[j,y]=d.useState(!0),[h,x]=d.useState({message:"",type:"info",visible:!1}),p=d.useRef(null),M=(s,r)=>{x({message:s,type:r,visible:!0})},N=()=>{p.current?.scrollIntoView({behavior:"smooth"})};d.useEffect(()=>{N()},[u]),d.useEffect(()=>{if(!t)return;(async()=>{try{const r=await D(t);if(r.success&&r.data){if(Array.isArray(r.data.messages)?n(r.data.messages):n([]),r.data.messages&&r.data.messages.length>0){const l=r.data.messages[0],a=l.sender._id===f?.id?l.recipient:l.sender;v(a)}}else n([]);await b(t)}catch(r){console.error("Error fetching direct messages:",r),n([]),M("Failed to load messages","error")}finally{y(!1)}})()},[t,f?.id]),d.useEffect(()=>{const s=a=>{(a.sender._id===t||a.recipient._id===t)&&(n(m=>[...m,a]),a.sender._id===t&&t&&b(t))},r=a=>{a.senderId===t&&n(m=>m.map(i=>i.sender._id===a.senderId&&!i.readAt?{...i,readAt:a.readAt}:i))},l=a=>{a.readerId===t&&f&&n(m=>m.map(i=>i.sender._id===f.id&&i.recipient._id===a.readerId&&!i.readAt?{...i,readAt:a.readAt}:i))};return o.on("newDirectMessage",s),o.on("directMessagesRead",r),o.on("allDirectMessagesRead",l),()=>{o.off("newDirectMessage",s),o.off("directMessagesRead",r),o.off("allDirectMessagesRead",l)}},[t]);const w=(s,r)=>{!t||!s.trim()&&!r||o.emit("sendDirectMessage",{receiverId:t,content:s,imageUrl:r})};return j?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"})}):c?e.jsxs("div",{className:"flex flex-col h-full bg-white dark:bg-gray-900",children:[e.jsxs("div",{className:"flex items-center p-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("button",{onClick:()=>g("/direct-messages"),className:"mr-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800",children:e.jsx(E,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex items-center",children:[c.avatar?e.jsx("img",{src:c.avatar,alt:c.username,className:"w-10 h-10 rounded-full mr-3"}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center mr-3",children:e.jsx("span",{className:"text-white font-semibold",children:c.username.charAt(0).toUpperCase()})}),e.jsx("div",{children:e.jsx("h2",{className:"font-semibold text-gray-900 dark:text-white",children:c.username})})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[u.length===0?e.jsx("div",{className:"text-center text-gray-500 dark:text-gray-400 mt-8",children:"No messages yet. Start a conversation!"}):u.map(s=>e.jsx(I,{msg:{_id:s._id,content:s.content,imageUrl:s.imageUrl,sender:{_id:s.sender._id,username:s.sender.username,avatar:s.sender.avatar||""},createdAt:s.createdAt,room:""},isMe:s.sender._id===f?.id},s._id)),e.jsx("div",{ref:p})]}),e.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 p-4",children:e.jsx(U,{onSend:w})}),e.jsx(R,{message:h.message,type:h.type,isVisible:h.visible,onClose:()=>x(s=>({...s,visible:!1}))})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800 dark:text-gray-200",children:"User not found"}),e.jsx("button",{onClick:()=>g("/direct-messages"),className:"mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",children:"Back to Messages"})]})})};export{P as default};
