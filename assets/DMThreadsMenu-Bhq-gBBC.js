import{j as e,m as _,A as C}from"./ui-vendor-BEMU751j.js";import{r as o}from"./react-vendor-oin3n_bH.js";import{h as T}from"./social-ZqStCY2R.js";import{y as D,s as w}from"./auth-CEE9aHD-.js";import"./chat-DCR_-ZuK.js";import"./editor-vendor-DpIsqUJN.js";import"./socket-vendor-BLRFddlS.js";const U=({totalUnreadCount:t,onToggle:d})=>e.jsxs(_.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:d,className:"relative group flex items-center gap-2 text-white hover:text-pink-300 transition-colors",title:"Direct Messages",children:[e.jsx(D,{className:"text-2xl"}),t>0&&e.jsx("span",{className:"absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-medium",children:t>99?"99+":t}),e.jsx("span",{className:"text-sm opacity-90 group-hover:opacity-100 transition-opacity hidden sm:inline",children:"Messages"})]}),k=({onClose:t})=>e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-white/20",children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Direct Messages"}),e.jsx("button",{onClick:t,className:"text-white/70 hover:text-white text-xl leading-none w-6 h-6 flex items-center justify-center rounded-full hover:bg-white/10 transition-colors",children:"Ã—"})]}),R=({thread:t,currentUser:d,onOpenDM:j,onClose:h})=>{const l=i=>{const u=new Date(i),b=new Date().getTime()-u.getTime(),f=Math.floor(b/6e4),x=Math.floor(f/60),g=Math.floor(x/24);return f<1?"Just now":f<60?`${f}m`:x<24?`${x}h`:g<7?`${g}d`:u.toLocaleDateString()},c=(i,u=30)=>i.length<=u?i:i.substring(0,u)+"...";return e.jsx("div",{onClick:()=>{j(t.otherUser),h()},className:"p-4 hover:bg-white/5 cursor-pointer transition-colors",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[t.otherUser.avatar?e.jsx("img",{src:t.otherUser.avatar,alt:t.otherUser.username,className:"w-12 h-12 rounded-full border-2 border-white/20"}):e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center border-2 border-white/20",children:e.jsx("span",{className:"text-white text-lg font-medium",children:t.otherUser.username.charAt(0).toUpperCase()})}),t.unreadCount>0&&e.jsx("div",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:t.unreadCount>9?"9+":t.unreadCount})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-white font-medium truncate",children:t.otherUser.username}),t.lastMessage&&e.jsx("span",{className:"text-xs text-white/50 flex-shrink-0",children:l(t.lastMessage.createdAt)})]}),t.lastMessage&&e.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[t.lastMessage.sender._id===d._id&&e.jsx("span",{className:"text-white/50 text-xs",children:"You: "}),e.jsx("p",{className:`text-sm truncate ${t.unreadCount>0?"text-white font-medium":"text-white/70"}`,children:t.lastMessage.imageUrl?"ðŸ“· Image":c(t.lastMessage.content)}),t.lastMessage.sender._id===d._id&&t.lastMessage.readAt&&e.jsx("span",{className:"text-green-400 text-xs ml-auto",children:"âœ“âœ“"})]})]})]})})},E=({threads:t,currentUser:d,loading:j,onOpenDM:h,onClose:l})=>j?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white"})}):t.length===0?e.jsxs("div",{className:"text-center text-white/60 py-8",children:[e.jsx(D,{className:"text-3xl mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No messages yet"}),e.jsx("p",{className:"text-xs",children:"Start a conversation with a friend!"})]}):e.jsx("div",{className:"divide-y divide-white/10",children:t.map(c=>e.jsx(R,{thread:c,currentUser:d,onOpenDM:h,onClose:l},c.otherUser._id))}),z=({currentUser:t,onOpenDM:d,className:j=""})=>{const[h,l]=o.useState(!1),[c,i]=o.useState([]),[u,N]=o.useState(!1),[b,f]=o.useState(0),x=o.useRef(null);o.useEffect(()=>{g()},[]),o.useEffect(()=>{const n=s=>{const M=s.sender._id===t._id?s.recipient._id:s.sender._id,r=s.sender._id===t._id?s.recipient:s.sender;i(y=>{const p=y.findIndex(a=>a.otherUser._id===M);if(p>=0){const a=[...y];a[p]={...a[p],lastMessage:{_id:s._id,sender:s.sender,recipient:s.recipient,content:s.content,imageUrl:s.imageUrl,readAt:s.readAt,createdAt:s.createdAt,updatedAt:s.updatedAt},unreadCount:s.sender._id!==t._id?a[p].unreadCount+1:a[p].unreadCount};const[A]=a.splice(p,1);return[A,...a]}else return[{otherUser:{_id:r._id,username:r.username,avatar:r.avatar||""},lastMessage:{_id:s._id,sender:s.sender,recipient:s.recipient,content:s.content,imageUrl:s.imageUrl,readAt:s.readAt,createdAt:s.createdAt,updatedAt:s.updatedAt},unreadCount:s.sender._id!==t._id?1:0},...y]})},m=({senderId:s})=>{i(M=>M.map(r=>r.otherUser._id===s?{...r,unreadCount:0}:r))},v=({readerId:s})=>{i(M=>M.map(r=>r.otherUser._id===s&&r.lastMessage?{...r,lastMessage:{...r.lastMessage,readAt:new Date().toISOString()}}:r))};return w.on("newDirectMessage",n),w.on("directMessagesRead",m),w.on("allDirectMessagesRead",v),()=>{w.off("newDirectMessage",n),w.off("directMessagesRead",m),w.off("allDirectMessagesRead",v)}},[t._id]),o.useEffect(()=>{const n=c.reduce((m,v)=>m+v.unreadCount,0);f(n)},[c]),o.useEffect(()=>{const n=m=>{x.current&&!x.current.contains(m.target)&&l(!1)};return document.addEventListener("mousedown",n),()=>document.removeEventListener("mousedown",n)},[]);const g=async()=>{try{N(!0);const n=await T();n.success&&n.data&&i(n.data)}catch(n){console.error("Failed to load DM threads:",n)}finally{N(!1)}};return e.jsxs("div",{className:`relative ${j}`,ref:x,children:[e.jsx(U,{totalUnreadCount:b,onToggle:()=>l(!h)}),e.jsx(C,{children:h&&e.jsxs(_.div,{initial:{opacity:0,scale:.95,y:-10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:-10},className:"absolute right-0 mt-2 w-80 bg-white/10 backdrop-blur-md rounded-xl shadow-xl border border-white/20 z-50 overflow-hidden",children:[e.jsx(k,{onClose:()=>l(!1)}),e.jsx("div",{className:"max-h-96 overflow-y-auto",children:e.jsx(E,{threads:c,currentUser:t,loading:u,onOpenDM:d,onClose:()=>l(!1)})})]})})]})};export{z as default};
